name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Git SHA or tag to deploy'
        required: true
        type: string
      confirm:
        description: 'Type "DEPLOY" to confirm production deployment'
        required: true
        type: string

env:
  SERVICE_NAME: backend
  WORKING_DIR: backend
  ENVIRONMENT: production

jobs:
  validate-deployment:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
            echo "âŒ Deployment not confirmed. You must type 'DEPLOY' in the confirm field."
            exit 1
          fi
          echo "âœ… Deployment confirmed"

  load-config:
    name: Load Environment Config
    runs-on: ubuntu-latest
    needs: validate-deployment
    outputs:
      app_name: ${{ steps.config.outputs.app_name }}
      resource_group: ${{ steps.config.outputs.resource_group }}
      acr_name: ${{ steps.config.outputs.acr_name }}
      slot_name: ${{ steps.config.outputs.slot_name }}
      health_url: ${{ steps.config.outputs.health_url }}
      concurrency_group: ${{ steps.config.outputs.concurrency_group }}
      blue_green: ${{ steps.config.outputs.blue_green }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Parse production config
        id: config
        shell: bash
        run: |
          # Install yq for YAML parsing
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          CONFIG_FILE="${{ env.WORKING_DIR }}/config/environments/production.yml"
          
          APP_NAME=$(yq eval '.azure.app_name' $CONFIG_FILE)
          RESOURCE_GROUP=$(yq eval '.azure.resource_group' $CONFIG_FILE)
          ACR_NAME=$(yq eval '.azure.acr_name' $CONFIG_FILE)
          SLOT_NAME=$(yq eval '.azure.slot_name' $CONFIG_FILE)
          HEALTH_URL=$(yq eval '.deployment.health_check_url' $CONFIG_FILE)
          CONCURRENCY_GROUP=$(yq eval '.deployment.concurrency_group' $CONFIG_FILE)
          BLUE_GREEN=$(yq eval '.deployment.blue_green_deployment' $CONFIG_FILE)
          
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "resource_group=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "slot_name=$SLOT_NAME" >> $GITHUB_OUTPUT
          echo "health_url=$HEALTH_URL" >> $GITHUB_OUTPUT
          echo "concurrency_group=$CONCURRENCY_GROUP" >> $GITHUB_OUTPUT
          echo "blue_green=$BLUE_GREEN" >> $GITHUB_OUTPUT

  build-and-deploy:
    name: Build and Deploy
    needs: load-config
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval
    concurrency:
      group: ${{ needs.load-config.outputs.concurrency_group }}
      cancel-in-progress: false  # Never cancel production deployments
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
      
      - name: Build Docker image
        uses: ./.github/actions/build-docker
        with:
          service-name: ${{ env.SERVICE_NAME }}
          acr-name: ${{ needs.load-config.outputs.acr_name }}
          dockerfile-path: ${{ env.WORKING_DIR }}/docker/Dockerfile
          context-path: ${{ env.WORKING_DIR }}
          image-tag: ${{ github.event.inputs.version }}
      
      - name: Deploy to staging slot (blue-green)
        if: needs.load-config.outputs.blue_green == 'true'
        uses: ./.github/actions/deploy-azure
        with:
          app-name: ${{ needs.load-config.outputs.app_name }}
          slot-name: staging
          image: ${{ needs.load-config.outputs.acr_name }}.azurecr.io/${{ env.SERVICE_NAME }}:${{ github.event.inputs.version }}
          resource-group: ${{ needs.load-config.outputs.resource_group }}
          environment: ${{ env.ENVIRONMENT }}
      
      - name: Health check (staging slot)
        if: needs.load-config.outputs.blue_green == 'true'
        uses: ./.github/actions/health-check
        with:
          health-url: https://${{ needs.load-config.outputs.app_name }}-staging.azurewebsites.net/health
      
      - name: Login to Azure
        if: needs.load-config.outputs.blue_green == 'true'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Swap slots (blue-green)
        if: needs.load-config.outputs.blue_green == 'true'
        shell: bash
        run: |
          az webapp deployment slot swap \
            --name ${{ needs.load-config.outputs.app_name }} \
            --resource-group ${{ needs.load-config.outputs.resource_group }} \
            --slot staging \
            --target-slot production
      
      - name: Deploy to production slot (direct)
        if: needs.load-config.outputs.blue_green != 'true'
        uses: ./.github/actions/deploy-azure
        with:
          app-name: ${{ needs.load-config.outputs.app_name }}
          slot-name: ${{ needs.load-config.outputs.slot_name }}
          image: ${{ needs.load-config.outputs.acr_name }}.azurecr.io/${{ env.SERVICE_NAME }}:${{ github.event.inputs.version }}
          resource-group: ${{ needs.load-config.outputs.resource_group }}
          environment: ${{ env.ENVIRONMENT }}
      
      - name: Health check (production)
        uses: ./.github/actions/health-check
        with:
          health-url: ${{ needs.load-config.outputs.health_url }}/health
      
      - name: Login to Azure (for rollback)
        if: failure() && needs.load-config.outputs.blue_green == 'true'
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Rollback on failure
        if: failure() && needs.load-config.outputs.blue_green == 'true'
        shell: bash
        run: |
          echo "ðŸ”„ Rolling back deployment..."
          az webapp deployment slot swap \
            --name ${{ needs.load-config.outputs.app_name }} \
            --resource-group ${{ needs.load-config.outputs.resource_group }} \
            --slot staging \
            --target-slot production
          echo "âœ… Rollback completed"
      
      - name: Notify deployment success
        uses: ./.github/actions/notify
        if: success()
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: success
          environment: ${{ env.ENVIRONMENT }}
          service-name: ${{ env.SERVICE_NAME }}
      
      - name: Notify deployment failure
        uses: ./.github/actions/notify
        if: failure()
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          status: failure
          environment: ${{ env.ENVIRONMENT }}
          service-name: ${{ env.SERVICE_NAME }}

